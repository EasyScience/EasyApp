<!DOCTYPE html>
<html>

<head>

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Mulish&display=swap">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.2.0/css/all.css">
  <!-- <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> -->
  <script src="plotly-1.58.5.min.js"></script>

  <style type="text/css">

    :root {
      --fontPixelSize:14;
      --toolButtonHeight:calc(2.5 * var(--fontPixelSize));

      --tooltipWidth:120;

      --backgroundColor:#fff;
      --foregroundColor:#333;
      --buttonBackgroundColor:#f4f4f4;
      --buttonBackgroundHoveredColor:#fefefe;
      --buttonForegroundColor:#333;
      --buttonForegroundHoveredColor:#00a3e3;
      --buttonBorderColor:#ddd;
      --tooltipBackgroundColor:#e9e9e9;
      --tooltipForegroundColor:#333;
      --tooltipBorderColor:#ddd;

      --measuredLineWidth:1;
      --calculatedLineWidth:2;
      --differenceLineWidth:1;

      --measuredScatterColor:#abbac2;
      --measuredLineColor:#607D8B80;
      --measuredAreaColor:#607D8B50;
      --calculatedLineColor:#F44336;
      --differenceLineColor:#607D8B80;
      --differenceAreaColor:#607D8B50;
      --backgroundLineColor:#607D8Ba0;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      overflow: hidden;
      font-family: 'Mulish', sans-serif;
      font-size: calc(var(--fontPixelSize) * 1px);
    }

    #plotContainer {
      height: 100%;
      width: 100%;
      padding: calc(var(--fontPixelSize) * 1px);;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }

    #plotDiv { /* Plotly plot element */
      z-index: 0;
      width: 100%;
      height: calc(100% - var(--fontPixelSize) * 1px + 4px);
      margin-top: calc(-40px + var(--fontPixelSize) * 1px);
      display: none;
    }

    .modebar-container { /* Plotly toolbar */
      display: none;
    }

    div.plotly-notifier { /* Plotly notifier element */
      visibility: hidden;
    }

    #plotToolbar {
      z-index: 1;
    }

    #plotToolbar .toolbar-separator {
      width: calc(0.25 * var(--fontPixelSize) * 1px);
      margin-left: calc(0.25 * var(--fontPixelSize) * 1px);
      display: inline-block;
    }

    #plotToolbar button {
      width: calc(var(--toolButtonHeight) * 1px);
      height: calc(var(--toolButtonHeight) * 1px);
      margin-left: calc(0.25 * var(--fontPixelSize) * 1px);
      font-size: calc(1.25 * var(--fontPixelSize) * 1px);
      color: var(--buttonForegroundColor);
      background: var(--buttonBackgroundColor);
      border: 1px solid var(--buttonBorderColor);
    }

    #plotToolbar button:hover {
      color: var(--buttonForegroundHoveredColor);
      background: var(--buttonBackgroundHoveredColor);
    }

    #plotToolbar button:focus {
      outline: 0;
    }

    #plotToolbar button:active { /* On button pressed, but not released */
    }

    #plotToolbar button.highlighted { /* Highlighted buttons */
      color: var(--buttonForegroundHoveredColor);
    }

    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]::after {
      content: attr(data-tooltip);
      display: inline-block;
      white-space: nowrap;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translate(-50%, calc(-0.75 * var(--fontPixelSize) * 1px));
      font-family: 'Mulish', sans-serif;
      font-size: calc(var(--fontPixelSize) * 1px);
      padding: calc(0.75 * var(--fontPixelSize) * 1px) calc(var(--fontPixelSize) * 1px);
      background-color: var(--tooltipBackgroundColor);
      color: var(--tooltipForegroundColor);
      border: 1px solid var(--tooltipBorderColor);
      border-radius: calc(0.25 * var(--fontPixelSize) * 1px);
      opacity: 0;
      transition: opacity 0.5s;
    }

    [data-tooltip]:hover::after {
        opacity: 1;
    }

  </style>

</head>

<body>

  <div id='plotContainer'>
    <div id='plotToolbar'></div>
    <div id='plotDiv'></div>
  </div>

  <script>

    // Example dataset with measured data and calculated profiles for 2 phases

    const data = {
      'x': [25,25.05,25.1,25.15,25.2,25.25,25.3,25.35,25.4,25.45,25.5,25.55,25.6,25.65,25.7,25.75,25.8,25.85,25.9,25.95,26,26.05,26.1,26.15,26.2,26.25,26.3,26.35,26.4,26.45,26.5,26.55,26.6,26.65,26.7,26.75,26.8,26.85,26.9,26.95,27,27.05,27.1,27.15,27.2,27.25,27.3,27.35,27.4,27.45,27.5,27.55,27.6,27.65,27.7,27.75,27.8,27.85,27.9,27.95,28,28.05,28.1,28.15,28.2,28.25,28.3,28.35,28.4,28.45,28.5,28.55,28.6,28.65,28.7,28.75,28.8,28.85,28.9,28.95,29,29.05,29.1,29.15,29.2,29.25,29.3,29.35,29.4,29.45,29.5,29.55,29.6,29.65,29.7,29.75,29.8,29.85,29.9,29.95,30,30.05,30.1,30.15,30.2,30.25,30.3,30.35,30.4,30.45,30.5,30.55,30.6,30.65,30.7,30.75,30.8,30.85,30.9,30.95,31,31.05,31.1,31.15,31.2,31.25,31.3,31.35,31.4,31.45,31.5,31.55,31.6,31.65,31.7,31.75,31.8,31.85,31.9,31.95,32,32.05,32.1,32.15,32.2,32.25,32.3,32.35,32.4,32.45,32.5,32.55,32.6,32.65,32.7,32.75,32.8,32.85,32.9,32.95,33,33.05,33.1,33.15,33.2,33.25,33.3,33.35,33.4,33.45,33.5,33.55,33.6,33.65,33.7,33.75,33.8,33.85,33.9,33.95,34,34.05,34.1,34.15,34.2,34.25,34.3,34.35,34.4,34.45,34.5,34.55,34.6,34.65,34.7,34.75,34.8,34.85,34.9,34.95,35],
      'measured': {
        'y': [196,192,198,187,199,193,176,176,163,155,154,160,146,149,151,146,148,150,139,152,148,146,142,153,156,155,160,167,175,187,203,206,214,224,210,211,204,200,195,219,240,261,316,385,456,529,570,569,556,506,453,416,390,408,447,529,612,719,777,793,747,655,546,439,353,289,244,223,215,219,205,200,191,172,173,165,152,151,147,150,156,145,149,149,146,146,141,145,149,146,151,149,153,149,144,156,150,152,157,154,145,158,162,158,168,176,193,212,234,275,331,389,478,544,608,650,692,719,793,921,1123,1432,1784,2178,2444,2521,2409,2143,1833,1537,1388,1417,1566,1826,2096,2267,2263,2046,1716,1329,964,687,510,394,352,345,367,363,355,353,327,303,269,239,224,214,205,206,218,217,224,235,222,217,205,192,180,174,164,155,151,153,154,150,147,154,155,164,166,167,186,200,223,248,271,281,273,267,242,226,196,172,156,150,157,144,142,149,149,147,141],
        'y_upper': [210,205.86,212.07,200.67,213.11,206.89,189.27,189.27,175.77,167.45,166.41,172.65,158.08,161.21,163.29,158.08,160.17,162.25,150.79,164.33,160.17,158.08,153.92,165.37,168.49,167.45,172.65,179.92,188.23,200.67,217.25,220.35,228.63,238.97,224.49,225.53,218.28,214.14,208.96,233.8,255.49,277.16,333.78,404.62,477.35,552,593.87,592.85,579.58,528.49,474.28,436.4,409.75,428.2,468.14,552,636.74,745.81,804.87,821.16,774.33,680.59,569.37,459.95,371.79,306,259.62,237.93,229.66,233.8,219.32,214.14,204.82,185.11,186.15,177.85,164.33,163.29,159.12,162.25,168.49,157.04,161.21,161.21,158.08,158.08,152.87,157.04,161.21,158.08,163.29,161.21,165.37,161.21,156,168.49,162.25,164.33,169.53,166.41,157.04,170.57,174.73,170.57,180.96,189.27,206.89,226.56,249.3,291.58,349.19,408.72,499.86,567.32,632.66,675.5,718.31,745.81,821.16,951.35,1156.51,1469.84,1826.24,2224.67,2493.44,2571.21,2458.08,2189.29,1875.81,1576.2,1425.26,1454.64,1605.57,1868.73,2141.78,2314.61,2310.57,2091.23,1757.42,1365.46,995.05,713.21,532.58,413.85,370.76,363.57,386.16,382.05,373.84,371.79,345.08,320.41,285.4,254.46,238.97,228.63,219.32,220.35,232.76,231.73,238.97,250.33,236.9,231.73,219.32,205.86,193.42,187.19,176.81,167.45,163.29,165.37,166.41,162.25,159.12,166.41,167.45,176.81,178.88,179.92,199.64,214.14,237.93,263.75,287.46,297.76,289.52,283.34,257.56,241.03,210,185.11,168.49,162.25,169.53,156,153.92,161.21,161.21,159.12,152.87],
        'y_lower': [182,178.14,183.93,173.33,184.89,179.11,162.73,162.73,150.23,142.55,141.59,147.35,133.92,136.79,138.71,133.92,135.83,137.75,127.21,139.67,135.83,133.92,130.08,140.63,143.51,142.55,147.35,154.08,161.77,173.33,188.75,191.65,199.37,209.03,195.51,196.47,189.72,185.86,181.04,204.2,224.51,244.84,298.22,365.38,434.65,506,546.13,545.15,532.42,483.51,431.72,395.6,370.25,387.8,425.86,506,587.26,692.19,749.13,764.84,719.67,629.41,522.63,418.05,334.21,272,228.38,208.07,200.34,204.2,190.68,185.86,177.18,158.89,159.85,152.15,139.67,138.71,134.88,137.75,143.51,132.96,136.79,136.79,133.92,133.92,129.13,132.96,136.79,133.92,138.71,136.79,140.63,136.79,132,143.51,137.75,139.67,144.47,141.59,132.96,145.43,149.27,145.43,155.04,162.73,179.11,197.44,218.7,258.42,312.81,369.28,456.14,520.68,583.34,624.5,665.69,692.19,764.84,890.65,1089.49,1394.16,1741.76,2131.33,2394.56,2470.79,2359.92,2096.71,1790.19,1497.8,1350.74,1379.36,1526.43,1783.27,2050.22,2219.39,2215.43,2000.77,1674.58,1292.54,932.95,660.79,487.42,374.15,333.24,326.43,347.84,343.95,336.16,334.21,308.92,285.59,252.6,223.54,209.03,199.37,190.68,191.65,203.24,202.27,209.03,219.67,207.1,202.27,190.68,178.14,166.58,160.81,151.19,142.55,138.71,140.63,141.59,137.75,134.88,141.59,142.55,151.19,153.12,154.08,172.36,185.86,208.07,232.25,254.54,264.24,256.48,250.66,226.44,210.97,182,158.89,143.51,137.75,144.47,132,130.08,136.79,136.79,134.88,129.13],
      },
      'calculated': {
        'y': [206.06,200.66,197.51,199.76,198.63,193.55,185.57,176.41,167.59,160.09,154.31,150.23,147.54,145.87,144.87,144.14,143.91,143.79,143.78,143.88,144.07,144.38,144.81,146.13,147.82,150.6,154.99,161.51,170.43,181.51,193.74,205.29,213.65,216.49,213.27,205.77,196.75,192.59,192.2,200.27,220.12,254.81,306.04,372.43,447.79,521.04,575.37,594.2,571.2,521.77,459.97,407.44,379.36,385.47,429.17,506.49,605.32,705.34,778.24,800.76,760.44,671.67,561.36,453.24,362.67,296.33,253.92,230.64,219.86,214.98,208.97,203.47,194.84,184.93,175.4,167.32,161.14,156.8,153.97,152.21,151.16,150.42,150.16,150.03,150.02,150.1,150.29,150.57,150.94,151.4,151.96,152.61,153.38,154.26,155.26,156.4,157.71,159.19,160.88,162.81,165.03,167.59,170.57,174.06,178.19,185.32,196.34,212.34,237.4,275.08,327.97,395.81,473.72,551.12,612.49,657.19,672.67,686.47,733.93,851.1,1063.51,1375.02,1758.02,2148.38,2448.73,2554.56,2441,2153.11,1813.62,1530.94,1379.39,1391.9,1557.59,1824.07,2103.73,2286.74,2275.74,2069.37,1729.27,1351.66,1006.23,733.16,543.78,429.88,373.94,356.33,352.12,366.05,370.15,358.96,334.23,303.18,272.08,245.57,226,214.32,210.43,213.24,220.66,229.21,235.87,235.91,228.04,214.49,198.88,184.23,172.2,163.33,157.34,153.54,151.23,149.5,148.84,148.39,148.17,148.17,149.43,151.53,155.72,163.26,175.51,193.37,216.48,242.46,266.49,281.75,282.2,267.47,243.3,216.65,192.58,173.67,160.39,151.92,146.88,143.97,141.88,141.07,140.42,139.88,139.43],
      },
      'background': {
        'y': [130.01,130.01,130.02,130.02,130.02,130.03,130.03,130.03,130.04,130.04,130.05,130.05,130.05,130.06,130.06,130.07,130.07,130.07,130.08,130.08,130.09,130.09,130.09,130.1,130.1,130.1,130.11,130.11,130.12,130.12,130.12,130.13,130.13,130.14,130.14,130.14,130.15,130.15,130.15,130.16,130.16,130.17,130.17,130.17,130.18,130.18,130.19,130.19,130.19,130.2,130.2,130.2,130.21,130.21,130.22,130.22,130.22,130.23,130.23,130.24,130.24,130.24,130.25,130.25,130.25,130.26,130.26,130.27,130.27,130.27,130.28,130.28,130.29,130.29,130.29,130.3,130.3,130.3,130.31,130.31,130.32,130.32,130.32,130.33,130.33,130.34,130.34,130.34,130.35,130.35,130.35,130.36,130.36,130.37,130.37,130.37,130.38,130.38,130.39,130.39,130.39,130.4,130.4,130.4,130.41,130.41,130.42,130.42,130.42,130.43,130.43,130.44,130.44,130.44,130.45,130.45,130.45,130.46,130.46,130.47,130.47,130.47,130.48,130.48,130.49,130.49,130.49,130.5,130.5,130.5,130.51,130.51,130.52,130.52,130.52,130.53,130.53,130.54,130.54,130.54,130.55,130.55,130.56,130.56,130.56,130.57,130.57,130.57,130.58,130.58,130.59,130.59,130.59,130.6,130.6,130.61,130.61,130.61,130.62,130.62,130.62,130.63,130.63,130.64,130.64,130.64,130.65,130.65,130.66,130.66,130.66,130.67,130.67,130.67,130.68,130.68,130.69,130.69,130.69,130.7,130.7,130.71,130.71,130.71,130.72,130.72,130.72,130.73,130.73,130.74,130.74,130.74,130.75,130.75,130.76,130.76,130.76,130.77,130.77,130.77,130.78],
      },
      'difference': {
        'y': [-10.06,-8.66,0.49,-12.76,0.37,-0.55,-9.57,-0.41,-4.59,-5.09,-0.31,9.77,-1.54,3.13,6.13,1.86,4.09,6.21,-4.78,8.12,3.93,1.62,-2.81,6.87,8.18,4.4,5.01,5.49,4.57,5.49,9.26,0.71,0.35,7.51,-3.27,5.23,7.25,7.41,2.8,18.73,19.88,6.19,9.96,12.57,8.21,7.96,-5.37,-25.2,-15.2,-15.77,-6.97,8.56,10.64,22.53,17.83,22.51,6.68,13.66,-1.24,-7.76,-13.44,-16.67,-15.36,-14.24,-9.67,-7.33,-9.92,-7.64,-4.86,4.02,-3.97,-3.47,-3.84,-12.93,-2.4,-2.32,-9.14,-5.8,-6.97,-2.21,4.84,-5.42,-1.16,-1.03,-4.02,-4.1,-9.29,-5.57,-1.94,-5.4,-0.96,-3.61,-0.38,-5.26,-11.26,-0.4,-7.71,-7.19,-3.88,-8.81,-20.03,-9.59,-8.57,-16.06,-10.19,-9.32,-3.34,-0.34,-3.4,-0.08,3.03,-6.81,4.28,-7.12,-4.49,-7.19,19.33,32.53,59.07,69.9,59.49,56.98,25.98,29.62,-4.73,-33.56,-32,-10.11,19.38,6.06,8.61,25.1,8.41,1.93,-7.73,-19.74,-12.74,-23.37,-13.27,-22.66,-42.23,-46.16,-33.78,-35.88,-21.94,-11.33,14.88,-3.05,-15.15,-5.96,-7.23,-0.18,-3.08,-6.57,-2,-0.32,-5.43,-7.24,-2.66,-12.21,-11.87,-0.91,-6.04,2.51,6.12,7.77,7.8,10.67,6.66,1.46,-0.23,3.5,5.16,1.61,-1.17,5.83,5.57,12.47,10.28,3.74,10.49,6.63,6.52,5.54,4.51,-0.75,-9.2,-0.47,-1.3,9.35,3.42,-1.67,-4.39,-1.92,10.12,0.03,0.12,7.93,8.58,7.12,1.57],
        'y_upper': [3.94,5.2,14.56,0.92,14.48,13.34,3.7,12.86,8.18,7.36,12.1,22.42,10.54,15.33,18.42,13.94,16.26,18.45,7.01,20.45,16.09,13.7,9.11,19.24,20.67,16.85,17.66,18.41,17.8,19.17,23.51,15.06,14.98,22.48,11.23,19.76,21.54,21.55,16.77,33.53,35.37,22.35,27.74,32.19,29.56,30.96,18.51,-1.35,8.38,6.72,14.32,28.96,30.39,42.73,38.97,45.51,31.41,40.47,26.63,20.4,13.9,8.92,8.01,6.71,9.12,9.67,5.7,7.29,9.8,18.81,10.35,10.67,9.98,0.19,10.75,10.52,3.19,6.49,5.16,10.04,17.33,6.62,11.04,11.17,8.07,7.98,2.59,6.47,10.27,6.68,11.33,8.59,11.99,6.95,0.74,12.09,4.54,5.14,8.65,3.6,-7.99,2.98,4.16,-3.49,2.77,3.95,10.55,14.22,11.9,16.5,21.22,12.91,26.15,16.2,20.17,18.31,45.64,59.34,87.23,100.25,93,94.82,68.21,76.28,44.71,16.65,17.09,36.18,62.19,45.26,45.86,62.74,47.98,44.66,38.05,27.87,34.83,21.86,28.15,13.79,-11.18,-19.95,-11.2,-16.03,-3.17,7.24,34.04,16,3.7,12.83,10.85,17.23,13.32,8.89,12.97,14.31,8.89,7.11,12.1,2.53,3.1,14.42,8.86,17.24,20.44,21.62,21.22,23.87,19.47,13.91,12.06,15.87,17.57,13.85,10.96,18.24,18.02,25.27,23.16,16.67,24.13,20.77,21.45,21.29,20.98,16.02,7.33,15.87,14.26,24.38,17.42,11.45,8.1,10.33,22.65,12.03,12.04,20.13,20.79,19.24,13.44],
        'y_lower': [-24.06,-22.51,-13.58,-26.43,-13.73,-14.45,-22.83,-13.67,-17.36,-17.54,-12.72,-2.88,-13.63,-9.08,-6.16,-10.22,-8.08,-6.04,-16.57,-4.2,-8.24,-10.46,-14.73,-5.5,-4.31,-8.05,-7.64,-7.44,-8.66,-8.18,-4.99,-13.64,-14.28,-7.46,-17.76,-9.29,-7.03,-6.73,-11.16,3.93,4.39,-9.96,-7.81,-7.05,-13.15,-15.04,-29.24,-49.06,-38.78,-38.27,-28.25,-11.84,-9.1,2.33,-3.32,-0.49,-18.06,-13.15,-29.12,-35.92,-40.77,-42.27,-38.73,-35.2,-28.46,-24.33,-25.54,-22.57,-19.53,-10.78,-18.29,-17.61,-17.66,-26.04,-15.55,-15.17,-21.47,-18.09,-19.09,-14.46,-7.65,-17.46,-13.37,-13.24,-16.1,-16.19,-21.16,-17.61,-14.14,-17.48,-13.25,-15.82,-12.75,-17.46,-23.26,-12.89,-19.95,-19.52,-16.41,-21.22,-32.07,-22.16,-21.3,-28.63,-23.15,-22.58,-17.23,-14.9,-18.7,-16.66,-15.16,-26.54,-17.58,-30.45,-29.15,-32.68,-6.98,5.71,30.91,39.55,25.98,19.14,-16.26,-17.05,-54.16,-83.77,-81.08,-56.41,-23.44,-33.15,-28.65,-12.54,-31.16,-40.81,-53.52,-67.36,-60.31,-68.6,-54.7,-59.12,-73.27,-72.37,-56.36,-55.73,-40.7,-29.91,-4.28,-22.11,-33.99,-24.75,-25.31,-17.59,-19.48,-22.03,-16.97,-14.94,-19.75,-21.59,-17.43,-26.94,-26.83,-16.24,-20.94,-12.22,-8.2,-6.09,-5.61,-2.52,-6.14,-10.99,-12.51,-8.87,-7.25,-10.64,-13.29,-6.58,-6.88,-0.34,-2.61,-9.18,-3.14,-7.51,-8.41,-10.2,-11.95,-17.51,-25.72,-16.81,-16.85,-5.69,-10.58,-14.78,-16.88,-14.17,-2.41,-11.97,-11.8,-4.28,-3.63,-5.01,-10.31],
      },
      'phase': [
        {
          'name': 'Si3N4_alpha',
          'y': [205.45,200.03,196.86,199.08,197.93,192.83,184.81,175.62,166.77,159.23,153.4,149.27,146.52,144.78,143.7,142.88,142.55,142.31,142.16,142.08,142.06,142.11,142.22,142.4,142.64,142.95,143.33,143.79,144.34,145,145.78,146.71,147.81,149.13,150.72,152.65,155.01,161.94,170.93,186.11,210.83,248.6,301.65,369.09,445.23,518.71,573.23,592.21,569.32,519.96,458.21,405.71,377.64,383.74,427.41,504.67,603.42,703.32,776.08,798.4,757.44,667.81,556,445.37,350.87,278.95,229.32,197.82,179.03,168.2,160.18,157.42,155.23,153.49,152.1,150.98,150.1,149.4,148.85,148.45,148.15,147.96,147.87,147.85,147.92,148.06,148.28,148.57,148.93,149.37,149.88,150.48,151.16,151.94,152.83,153.83,154.96,156.25,157.7,159.35,161.23,163.39,165.87,168.76,172.14,178.33,186.09,197.8,215.45,241.02,275.6,318.33,365.49,410.23,443.39,472.47,490.9,525.06,603,752.85,994.52,1329.02,1728.2,2128.93,2435.43,2544.74,2433.7,2146.54,1807.59,1525.28,1373.99,1386.64,1552.37,1818.79,2098.29,2281.03,2269.62,2062.68,1721.82,1341.32,991.98,712.09,511.44,380.46,300.98,254.73,220.32,208.64,199.31,191.78,185.67,181.2,177.94,176.36,176.97,180.41,187.15,197.11,209.23,221.19,229.56,230.8,223.77,210.82,195.68,181.37,169.62,160.99,155.2,151.59,149.42,147.83,147.29,146.95,146.81,146.9,148.24,150.4,154.65,162.24,174.54,192.45,215.6,241.61,265.68,280.97,281.45,266.75,242.6,215.98,191.93,173.03,159.78,151.32,146.29,143.4,141.32,140.53,139.89,139.36,138.92],
          'x_bragg': [25.19,27.34,27.94,30.72,30.72,31.24,31.24,31.78,33.04,34.28],
        },
        {
          'name': 'Si3N4_beta',
          'y': [130.62,130.64,130.67,130.69,130.72,130.75,130.78,130.82,130.86,130.91,130.96,131.01,131.08,131.15,131.23,131.32,131.43,131.56,131.7,131.88,132.1,132.36,132.68,133.82,135.28,137.76,141.77,147.84,156.21,166.63,178.08,188.71,195.97,197.5,192.69,183.26,171.88,160.8,151.42,144.32,139.45,136.38,134.55,133.51,132.74,132.51,132.32,132.18,132.08,132.01,131.96,131.93,131.93,131.94,131.98,132.04,132.13,132.24,132.4,132.59,133.24,134.1,135.61,138.13,142.05,147.65,154.86,163.09,171.1,177.06,179.07,176.34,169.9,161.73,153.6,146.64,141.35,137.71,135.42,134.08,133.32,132.78,132.62,132.51,132.43,132.38,132.35,132.34,132.36,132.39,132.43,132.5,132.58,132.68,132.8,132.95,133.12,133.32,133.56,133.85,134.19,134.6,135.1,135.71,136.46,137.4,140.67,144.96,152.37,164.48,182.8,207.92,238.66,271.34,299.55,315.17,312.22,291.88,261.39,228.71,199.45,176.48,160.3,149.94,143.78,140.31,137.79,137.07,136.54,136.16,135.91,135.77,135.74,135.8,135.97,136.25,136.65,137.22,137.99,140.88,144.79,151.62,162.89,179.98,203.52,232.16,262.37,287.99,301.41,297.76,279.15,252.57,224.74,199.81,179.63,164.51,153.88,146.74,142.05,138.63,136.93,135.73,134.9,134.31,133.84,133.5,133.23,132.99,132.79,132.62,132.47,132.33,132.22,132.12,132.03,131.95,131.88,131.82,131.76,131.71,131.67,131.63,131.59,131.56,131.53,131.5,131.47,131.45,131.43,131.41,131.39,131.38,131.36,131.35,131.34,131.33,131.32,131.31,131.31,131.3,131.29],
          'x_bragg': [26.64,28.5,28.5,30.77,32.41,32.65],
        }
      ]
    }

    const colors = {
      'phase': ['#FF9800', '#4CAF50']
    }

    // Get access to the plotly-based chart created in the html body

    let plotDiv = document.getElementById('plotDiv')

    const style = getComputedStyle(document.documentElement)

    /////////////////////////////
    // Individual curves (traces)
    /////////////////////////////

    let measuredMinusSigmaTrace = {
      name: 'Meas - Sig',
      xaxis: 'x3',
      yaxis: 'y3',
      x: data.x,
      y: data.measured.y_lower,
      mode: 'lines',
      line: {
        width: style.getPropertyValue('--measuredLineWidth'),
        color: style.getPropertyValue('--measuredLineColor'),
      },
      showlegend: false,
      hoverinfo: 'skip',

      visible: true,
    }

    let measuredPlusSigmaTrace = {
      name: 'Standard Deviation',
      xaxis: 'x3',
      yaxis: 'y3',
      x: data.x,
      y: data.measured.y_upper,
      mode: 'lines',
      line: {
        width: style.getPropertyValue('--measuredLineWidth'),
        color: style.getPropertyValue('--measuredLineColor'),
      },
      //legendgroup: 'legend_main',
      hoverinfo: 'skip',
      fill: 'tonexty',
      fillcolor: style.getPropertyValue('--measuredAreaColor'),

      //visible: true,
    }

    let measuredTrace = {
      name: 'Measured',
      xaxis: 'x3',
      yaxis: 'y3',
      x: data.x,
      y: data.measured.y,
      mode: 'markers',
      marker : {
        symbol: 'circle',
        color: style.getPropertyValue('--measuredScatterColor'),
        size: 5,
      },
      //legendgroup: 'legend_main',
    }

    let calculatedTotalTrace = {
      name: 'Calculated Total',
      xaxis: 'x3',
      yaxis: 'y3',
      x: data.x,
      y: data.calculated.y,
      mode: 'lines',
      line: {
        //simplify: false,
        width: style.getPropertyValue('--calculatedLineWidth'),
        color: style.getPropertyValue('--calculatedLineColor'),
      },
      //legendgroup: 'legend_main',
    }

    let calculatedIndividualTraces = []
    for (const i in data.phase) {
      calculatedIndividualTraces.push({
        xaxis: 'x3',
        yaxis: 'y3',
        x: data.x,
        y: data.background.y,
        mode: 'lines',
        line: {
          width: 0,
        },
        showlegend: false,
        hoverinfo: 'skip',
      })
      calculatedIndividualTraces.push({
        name: 'Calculated ' + data.phase[i].name,
        xaxis: 'x3',
        yaxis: 'y3',
        x: data.x,
        y: data.phase[i].y,
        mode: 'lines',
        line: {
          width: 1,
          color: colors.phase[i],
        },
        fill: 'tonexty',
        fillcolor: colors.phase[i] + '30'
      })
    }




    let backgroundTrace = {
      name: 'Background',
      xaxis: 'x3',
      yaxis: 'y3',
      x: data.x,
      y: data.background.y,
      mode: 'lines',
      line: {
        dash: 'dot',
        width: 2,
        color: style.getPropertyValue('--backgroundLineColor'),
      },
      //legendgroup: 'legend_main',
    }

    let braggPeaksTraces = []
    for (const i in data.phase) {
      braggPeaksTraces.push({
        name: `${data.phase[i].name}`,
        xaxis: 'x2',
        yaxis: 'y2',
        x: data.phase[i].x_bragg,
        y: Array(data.phase[i].x_bragg.length).fill(i),
        mode: 'markers',
        marker : {
          symbol: 'line-ns-open',
          size: style.getPropertyValue('--fontPixelSize'),
          color: colors.phase[i],
          line: { width: 1 },
        },
        showlegend: false,
      })
    }

    let residualMinusSigmaTrace = {
      x: data.x,
      y: data.difference.y_lower,
      mode: 'lines',
      line: {
        width: style.getPropertyValue('--differenceLineWidth'),
        color: style.getPropertyValue('--differenceLineColor'),
      },
      showlegend: false,
      hoverinfo: 'skip',
    }

    let residualPlusSigmaTrace = {
      x: data.x,
      y: data.difference.y_upper,
      mode: 'lines',
      line: {
        width: style.getPropertyValue('--differenceLineWidth'),
        color: style.getPropertyValue('--differenceLineColor'),
      },
      showlegend: false,
      hoverinfo: 'skip',
      fill: 'tonexty',
      fillcolor: style.getPropertyValue('--differenceAreaColor'),
    }

    let residualTrace = {
      x: data.x,
      y: data.difference.y,
      mode: 'markers',
      marker : {
        symbol: 'circle',
        color: style.getPropertyValue('--measuredScatterColor'),
        size: 5,
      },
      showlegend: false,
      hoverinfo: 'skip',
    }

    // Combine all individual plot traces into an array

    let plotTraces = [ measuredMinusSigmaTrace,
                 measuredPlusSigmaTrace,
                 measuredTrace,
                 ...calculatedIndividualTraces,
                 calculatedTotalTrace,
                 backgroundTrace,

                 ...braggPeaksTraces,

                 residualMinusSigmaTrace,
                 residualPlusSigmaTrace,
                 residualTrace ]

    ///////////////////////////////////
    // Plot layout: axes, margins, etc.
    ///////////////////////////////////

    let layout = {
      autosize: true,
      margin: { l: 43, r: 3, b: 50, t: 40, pad: 0 },
      showlegend: true,
      legend: {
        x: 0.99,
        y: 0.99,
        xanchor: 'right',
        bgcolor: '#ffffffa0'
      },
      xaxis: {
        title: '2theta (deg)',
        automargin: true,
        autorange: false,
        range: [20, 100], //[Math.min(...data.x), Math.max(...data.x)],
        showgrid: true,
        zeroline: false,
        showline: true,
        linecolor: '#ccc',
        linewidth: 1,
        mirror: 'ticks',
      },
      xaxis2: {
        anchor: 'y2',
        matches: 'x',
        showgrid: true,
        zeroline: false,
        showline: true,
        linecolor: '#ccc',
        linewidth: 1,
        showticklabels: false,
        mirror: 'ticks',
      },
      xaxis3: {
        anchor: 'y3',
        matches: 'x',
        showgrid: true,
        zeroline: false,
        showline: true,
        linecolor: '#ccc',
        linewidth: 1,
        showticklabels: false,
        mirror: 'ticks',
      },
      yaxis: {
        title: 'Residual',
        domain: [0, 0.18], // initial values, updated below
        automargin: true,
        autorange: false,
        range: [0, 1], // initial values, updated below
        showgrid: true,
        zeroline: false,
        showline: true,
        linecolor: '#ccc',
        linewidth: 1,
        mirror: 'ticks',
      },
      yaxis2: {
        title: 'Bragg<br>Peaks',  // 'Bragg Peaks'
        domain: [0.20, 0.26], // initial values, updated below
        anchor: 'x2',
        autorange: true,
        showgrid: false,
        zeroline: false,
        showline: true,
        linecolor: '#ccc',
        linewidth: 1,
        showticklabels: false,
        mirror: 'ticks',
      },
      yaxis3: {
        //type: 'log',
        title: 'Intensity',
        domain: [0.28, 1], // initial values, updated below
        anchor: 'x3',
        automargin: true,
        autorange: true,
        showgrid: true,
        zeroline: false,
        showline: true,
        linecolor: '#ccc',
        linewidth: 1,
        mirror: 'ticks',
      },
    }

    let config = {
      displayModeBar: true,
      displaylogo: false,
    }

    // Display plot based on the data described above

    Plotly.newPlot(plotDiv, plotTraces, layout, config)

    // Custom toolbar

    function createToolbarSeparator() {
      const element = document.createElement("span")
      element.classList.toggle("toolbar-separator")
      return element
    }

    function createPlotlyModebarDependentToolbarButton(conf, i) {
      const plotly_button = document.querySelector(`a[data-val=${conf[i].plotly_data_val}]`)
      const custom_button = document.createElement("button")
      custom_button.id = conf[i].custom_id
      if ('fa_icon' in conf[i]) {
        custom_button.innerHTML = `<i class="${conf[i].fa_icon}"></i>`
      } else if ('text' in conf[i]) {
        custom_button.innerHTML = conf[i].text
      }
      custom_button.setAttribute("data-tooltip", conf[i].tooltip)
      custom_button.addEventListener("click", function() {
        plotly_button.click()
        highlightPlotlyModebarDependentButtons(conf)
        if (conf[i].plotly_data_val === 'reset') {  // Temporary fix to update residual curve
          updateResidualYAxisRange()
          Plotly.relayout(plotDiv, layout)
        }
      })
      return custom_button
    }

    function createPlotlyModebarIndependentToolbarButton(conf, i) {
      const custom_button = document.createElement("button")
      custom_button.id = conf[i].custom_id
      if ('fa_icon' in conf[i]) {
        custom_button.innerHTML = `<i class="${conf[i].fa_icon}"></i>`
      } else if ('text' in conf[i]) {
        custom_button.innerHTML = conf[i].text
      }
      custom_button.setAttribute("data-tooltip", conf[i].tooltip)
      custom_button.addEventListener("click", function() {
        eval(conf[i].custom_action)()
      })
      return custom_button
    }

    function highlightPlotlyModebarDependentButtons(conf) {
      for (const i in conf) {
        if ('plotly_data_val' in conf[i]) {
          const plotly_button = document.querySelector(`a[data-val=${conf[i].plotly_data_val}]`)
          const custom_button = document.getElementById(conf[i].custom_id)
          if (plotly_button.classList.contains("active")) {
            custom_button.classList.add("highlighted")
          } else {
            custom_button.classList.remove("highlighted")
          }
        }
      }
    }

    function createToolbarButtons(conf) {
      const toolbar = document.getElementById("plotToolbar")
      for (const i in conf) {
        let element = {}
        if (JSON.stringify(conf[i]) === '{}') {
          element = createToolbarSeparator()
        } else if ('plotly_data_val' in conf[i]) {
          element = createPlotlyModebarDependentToolbarButton(conf, i)
        } else if ('custom_action' in conf[i]) {
          element = createPlotlyModebarIndependentToolbarButton(conf, i)
        } else {
          console.log('Error in toolbar button creation')
        }
        toolbar.appendChild(element)
      }
    }

    const conf = [//{'custom_id': 'custom_log', 'text': 'log', 'custom_action': 'logScaleY'},
      {'custom_id': 'custom_log', 'fa_icon': 'fa-solid fa-rectangle-list', 'custom_action': 'toggleLegendVisibility', 'tooltip': 'Show / hide legend'},
      {},
      {'custom_id': 'custom_zoom', 'fa_icon': 'fa-solid fa-magnifying-glass', 'plotly_data_val': 'zoom', 'tooltip': 'Zoom'},
      {'custom_id': 'custom_pan', 'fa_icon': 'fa-solid fa-arrows-up-down-left-right', 'plotly_data_val': 'pan', 'tooltip': 'Pan'},
      {},
      {'custom_id': 'custom_reset', 'fa_icon': 'fa-solid fa-house-chimney', 'plotly_data_val': 'reset', 'tooltip': 'Reset to initital state'}
    ]

    createToolbarButtons(conf)
    highlightPlotlyModebarDependentButtons(conf)

    // Extra plot specific functions

    plotDiv.on('plotly_legendclick', function(event) {
      console.log('curve ' + event.curveNumber + ' clicked')
      if (event.data[event.curveNumber].fill === 'tonexty') {
        if (event.data[event.curveNumber].visible === true || typeof event.data[event.curveNumber].visible === 'undefined') {
          event.data[event.curveNumber - 1].visible = false
        } else if (event.data[event.curveNumber].visible === 'legendonly') {
          event.data[event.curveNumber - 1].visible = true
        }
      }
    })

    plotDiv.on('plotly_legenddoubleclick', function(event) {
      return false // to disable default behaviour

      measuredMinusSigmaTrace.visible = false //!measuredMinusSigmaTrace.visible
      measuredMinusSigmaTrace.showlegend = true
      measuredMinusSigmaTrace.visible = false //!measuredMinusSigmaTrace.visible
      measuredMinusSigmaTrace.showlegend = false
      for (const i in event.data) {
        if (i !== event.curveNumber && event.data[i].fill === 'tonexty') {
          //event.data[i - 1].visible = 'legendonly'
          console.log('++', event.curveNumber, i, i - 1, event.data[i].visible, event.data[i - 1].visible)
          if (event.data[i].visible === true || typeof event.data[i].visible === 'undefined') {
            //event.data[i - 1].visible = false
          } else if (event.data[i].visible === 'legendonly') {
            //event.data[i - 1].visible = false
          }
        }
      }
    })



    function updateYAxesHeights() {
      const heightCorrection = 140
      const fontRatioSize = style.getPropertyValue('--fontPixelSize') /
                            (window.innerHeight - heightCorrection)

      layout.yaxis.domain[0] = 0
      layout.yaxis.domain[1] = 0.18

      layout.yaxis2.domain[0] = layout.yaxis.domain[1] + fontRatioSize
      layout.yaxis2.domain[1] = layout.yaxis2.domain[0] +
                                1.6 * data.phase.length * fontRatioSize

      layout.yaxis3.domain[0] = layout.yaxis2.domain[1] + fontRatioSize
      layout.yaxis3.domain[1] = 1
    }

    function updateResidualYAxisRange() {
      const mainYAxisRelativeHeight = layout.yaxis3.domain[1] - layout.yaxis3.domain[0]
      const residualYAxisRelativeHeight = layout.yaxis.domain[1] - layout.yaxis.domain[0]

      const mainYAxisRange = layout.yaxis3.range[1] - layout.yaxis3.range[0]
      const residualYAxisRange = mainYAxisRange * residualYAxisRelativeHeight / mainYAxisRelativeHeight

      layout.yaxis.range[0] = -residualYAxisRange / 2
      layout.yaxis.range[1] = residualYAxisRange / 2
    }

    function showPlot() {
      document.getElementById("plotDiv").style.display = 'block'
    }

    function redrawPlot() {
      Plotly.redraw(plotDiv)
    }

    function relayoutPlot() {
      updateYAxesHeights()
      updateResidualYAxisRange()
      Plotly.relayout(plotDiv, layout)
    }

    function toggleLegendVisibility() {
      if (layout.showlegend === true) {
        layout.showlegend = false
      } else if (layout.showlegend === false) {
        layout.showlegend = true
      }
      redrawPlot()
    }

    // !!!!!!!!!!!

    function setMeasuredData(newData) {
      let out = '=== setMeasuredData finished.'
      if (JSON.stringify(measuredTrace.x) !== JSON.stringify(newData.x)) {
        measuredTrace.x = newData.x
        measuredMinusSigmaTrace.x = newData.x
        measuredPlusSigmaTrace.x = newData.x
        out += ' x is updated.'
      }
      if (JSON.stringify(measuredTrace.y) !== JSON.stringify(newData.y)) {
        measuredTrace.y = newData.y
        out += ' y is updated.'
      }
      if (JSON.stringify(measuredMinusSigmaTrace.y) !== JSON.stringify(newData.y_lower)) {
        measuredMinusSigmaTrace.y = newData.y_lower
        out += ' y_lower is updated.'
      }
      if (JSON.stringify(measuredPlusSigmaTrace.y) !== JSON.stringify(newData.y_upper)) {
        measuredPlusSigmaTrace.y = newData.y_upper
        out += ' y_upper is updated.'
      }
      return out + '\n' + JSON.stringify(newData)
    }



    function setAllCalculatedData(newData) {
      let out = '=== setAllCalculatedData finished.'
      //out += '\n newData.x ' + newData.x
      //if (JSON.stringify(calculatedTotalTrace.x) !== JSON.stringify(newData.x)) {
        calculatedTotalTrace.x = newData.x
        residualTrace.x = newData.x
        residualMinusSigmaTrace.x = newData.x
        residualPlusSigmaTrace.x = newData.x
        backgroundTrace.x = newData.x
        out += '\n x is updated.'
        out += '\n calculatedTotalTrace.x ' + calculatedTotalTrace.x
        out += '\n residualTrace.x ' + residualTrace.x
        out += '\n residualMinusSigmaTrace.x ' + residualMinusSigmaTrace.x
        out += '\n residualPlusSigmaTrace.x ' + residualPlusSigmaTrace.x
        out += '\n backgroundTrace.x ' + backgroundTrace.x
      //}
      //if (JSON.stringify(calculatedTotalTrace.y) !== JSON.stringify(newData.total.y)) {
        calculatedTotalTrace.y = newData.total.y
        residualTrace.y = newData.difference.y
        residualMinusSigmaTrace.y = newData.difference.y_lower
        residualPlusSigmaTrace.y = newData.difference.y_upper
        //for (const i in newData.phase) {
        //  braggPeaksTraces[i].x = newData.phase[i].x_bragg
        //  braggPeaksTraces[i].y = newData.phase[i].y_bragg
        //}
        out += '\n y is updated.'
        out += '\n calculatedTotalTrace.y ' + calculatedTotalTrace.y
        out += '\n residualTrace.y ' + residualTrace.y
        out += '\n residualMinusSigmaTrace.y ' + residualMinusSigmaTrace.y
        out += '\n residualPlusSigmaTrace.y ' + residualPlusSigmaTrace.y
      //}
      //if (JSON.stringify(backgroundTrace) !== JSON.stringify(newData.background)) {
        backgroundTrace.y = newData.background.y
        out += '\n background is updated.'
        out += '\n backgroundTrace.y ' + backgroundTrace.y
      //}
      for (const i in newData.phase) {
        //if (JSON.stringify(braggPeaksTraces[i].x) !== JSON.stringify(newData.phase[i].x_bragg)) {
          braggPeaksTraces[i].x = newData.phase[i].x_bragg
          braggPeaksTraces[i].y = newData.phase[i].y_bragg
          out += '\n hkl is updated.'
          out += `\n braggPeaksTraces[${i}].x ` + braggPeaksTraces[i].x
        //}
        //if (JSON.stringify(calculatedIndividualTraces[2*i+1].y) !== JSON.stringify(newData.phase[i].y)) {
          calculatedIndividualTraces[2*i+1].name = `Calculated ${newData.phase[i].name}`
          calculatedIndividualTraces[2*i].x = newData.x
          calculatedIndividualTraces[2*i+1].x = newData.x
          calculatedIndividualTraces[2*i].y = newData.background.y
          calculatedIndividualTraces[2*i+1].y = newData.phase[i].y
          out += '\n phases are updated.'
          out += `\n calculatedIndividualTraces[${2*i}].x ` + calculatedIndividualTraces[2*i].x
          out += `\n calculatedIndividualTraces[${2*i+1}].x ` + calculatedIndividualTraces[2*i+1].x
          out += `\n calculatedIndividualTraces[${2*i}].y ` + calculatedIndividualTraces[2*i].y
          out += `\n calculatedIndividualTraces[${2*i+1}].y ` + calculatedIndividualTraces[2*i+1].y
        //}
      }
      return out // + '\n' + JSON.stringify(newData)
    }



    function setCalculatedData(newData) {
      if (newData.length !== calculatedTotalTrace.x) {
        calculatedTotalTrace.x = newData.x
        //return `+++++ setCalculatedData finished: ${newData.x.length}, ${calculatedTotalTrace.x.length}`
      }
      //calculatedTotalTrace.x = newData.x
      //calculatedTotalTrace.y = newData.y

      //return '+++++ setCalculatedData finished'


      Plotly.animate(plotDiv, {
        data: [{ y: newData.y }],
        traces: [7]
      }, {
        transition: {
          easing: 'cubic-in-out',
          duration: 1000,
        },
        frame: {
          duration: 1000,
          ///redraw: false,
        }
      })

      ///return `+++++ setCalculatedData finished: ${newData.x.length}, ${calculatedTotalTrace.x.length}, ${JSON.stringify(newData.y)}`

    }

    function redrawPlotWithYAnimation() {
      Plotly.animate('chartDiv', {
        data: [{ y: yArrayValues }],
        traces: [0]
      }, {
        transition: {
          duration: 500,
          easing: 'cubic-in-out'
        },
        frame: {
          duration: 500
        }
      })
    }



    // dEBUG
    //const obj = {'phases': {'name': a}}




    // MISC

    window.addEventListener("load", showPlot)
    window.addEventListener("load", relayoutPlot)
    window.addEventListener("resize", relayoutPlot)

  </script>

</body>

</html>
